<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Premium Checkout</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="https://unpkg.com/@revenuecat/purchases-js/dist/index.js"></script>
    <script src="js/premium.js"></script>
    <script>tailwind.config={darkMode:"class",theme:{extend:{colors:{primary:"#f2cc0d","background-dark":"#181711","surface-dark":"#221f10","card-dark":"#393628"},fontFamily:{display:["Space Grotesk","sans-serif"]},borderRadius:{DEFAULT:"1rem",lg:"2rem",xl:"3rem",full:"9999px"}}}}</script>
    <style>
        .material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}
        body{min-height:max(884px,100dvh);font-family:'Space Grotesk',sans-serif}
        .pm-grad{background:linear-gradient(135deg,#8b5cf6 0%,#ec4899 50%,#6366f1 100%)}
        .pm-text{background:linear-gradient(135deg,#c084fc,#f472b6,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .pm-glow{box-shadow:0 0 30px rgba(139,92,246,0.25)}
        .gp{background:rgba(139,92,246,0.06);backdrop-filter:blur(12px);border:1px solid rgba(139,92,246,0.12)}
        .glass{background:rgba(57,54,40,0.3);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.05)}
        @keyframes fade-up{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
        @keyframes success-pop{0%{transform:scale(0);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
        .fade-up{animation:fade-up 0.5s ease forwards;opacity:0}
        .success-icon{animation:success-pop 0.6s cubic-bezier(0.34,1.56,0.64,1) forwards}
        /* RevenueCat Stripe Elements styling override */
        #rc-payment-container iframe{border-radius:14px!important}
    </style>
</head>
<body class="bg-background-dark text-white min-h-screen">
<div class="relative flex h-auto min-h-screen w-full flex-col max-w-[480px] mx-auto overflow-x-hidden pb-10">

    <!-- Header -->
    <header class="flex items-center p-4 pb-2 justify-between sticky top-0 z-50 bg-background-dark/90 backdrop-blur-md border-b border-white/5">
        <div onclick="history.back()" class="flex size-12 shrink-0 items-center justify-start cursor-pointer text-white">
            <span class="material-symbols-outlined">arrow_back_ios</span>
        </div>
        <h2 class="text-white text-lg font-bold flex-1 text-center">Ã–deme</h2>
        <div class="w-12 flex items-center justify-end">
            <span class="material-symbols-outlined text-green-500/60 text-lg" style="font-variation-settings:'FILL' 1">lock</span>
        </div>
    </header>

    <!-- â•â•â• Ã–DEME SAYFASI â•â•â• -->
    <div id="sec-checkout">

        <!-- Plan Ã–zeti -->
        <div class="px-5 pt-6 pb-4 fade-up">
            <div class="gp rounded-2xl p-4 flex items-center gap-4">
                <div class="size-12 rounded-full pm-grad flex items-center justify-center shrink-0">
                    <span class="material-symbols-outlined text-white text-xl" style="font-variation-settings:'FILL' 1">workspace_premium</span>
                </div>
                <div class="flex-1">
                    <p class="text-white font-bold">Kader Premium</p>
                    <p id="plan-label" class="text-white/40 text-xs">â€”</p>
                </div>
                <div class="text-right">
                    <p id="plan-price" class="text-white text-lg font-black">â€”</p>
                    <p id="plan-period" class="text-white/25 text-xs">â€”</p>
                </div>
            </div>
            <p class="text-white/20 text-xs text-center mt-2">Ä°lk 3 gÃ¼n Ã¼cretsiz Â· Ä°stediÄŸin zaman iptal</p>
        </div>

        <!-- RevenueCat Ã–deme Formu AlanÄ± -->
        <div class="px-5 pb-4 fade-up" style="animation-delay:0.06s">
            <p class="text-white/30 text-[10px] font-bold uppercase tracking-widest mb-3">Ã–deme Bilgileri</p>

            <!-- SDK bu div'e Stripe Elements formunu render edecek -->
            <div id="rc-payment-container" class="rounded-2xl overflow-hidden min-h-[60px]">
                <!-- Loading indicator -->
                <div id="payment-loading" class="flex items-center justify-center gap-3 py-8 glass rounded-2xl">
                    <div class="animate-spin size-5 border-2 border-white/20 border-t-purple-400 rounded-full"></div>
                    <p class="text-white/40 text-sm">Ã–deme formu yÃ¼kleniyor...</p>
                </div>
            </div>
        </div>

        <!-- GÃ¼venlik Notu -->
        <div class="px-5 pb-4 fade-up" style="animation-delay:0.1s">
            <div class="flex items-center gap-3 px-4 py-3 glass rounded-xl">
                <span class="material-symbols-outlined text-green-400 text-base" style="font-variation-settings:'FILL' 1">verified_user</span>
                <p class="text-white/40 text-xs">Stripe ile gÃ¼venli Ã¶deme Â· 256-bit SSL ÅŸifreleme</p>
            </div>
        </div>

        <!-- Ã–deme Butonu -->
        <div class="px-5 pb-4 fade-up" style="animation-delay:0.14s">
            <button id="btn-pay" class="w-full pm-grad text-white py-4 rounded-full font-bold text-base shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform pm-glow">
                <span class="material-symbols-outlined">credit_card</span>
                <span id="btn-pay-label">Ã–demeyi Tamamla</span>
            </button>
        </div>

        <!-- KoÅŸullar -->
        <div class="px-5 pb-4">
            <p class="text-white/15 text-[10px] text-center leading-relaxed">
                "Ã–demeyi Tamamla"ya basarak Kader KullanÄ±m KoÅŸullarÄ±'nÄ± kabul etmiÅŸ olursun.
                Abonelik seÃ§ilen dÃ¶nem sonunda otomatik yenilenir. Ä°stediÄŸin zaman iptal edebilirsin.
            </p>
        </div>

        <!-- Ãœcretsiz devam et -->
        <div class="px-5 pb-8 text-center">
            <a id="btn-skip" href="mystic_numerology_home_1.html" class="text-white/25 text-xs font-bold hover:text-white/40 transition-colors">
                Åžimdilik Ã¼cretsiz devam et â†’
            </a>
        </div>
    </div>

    <!-- â•â•â• BAÅžARI EKRANI â•â•â• -->
    <div id="sec-success" style="display:none" class="flex-1 flex flex-col items-center justify-center px-6 text-center">
        <div class="size-28 rounded-full pm-grad flex items-center justify-center mb-8 pm-glow success-icon" style="opacity:0">
            <span class="material-symbols-outlined text-white text-6xl" style="font-variation-settings:'FILL' 1">check_circle</span>
        </div>
        <h2 class="text-white text-2xl font-black mb-3">Premium Aktif! ðŸŽ‰</h2>
        <p class="text-white/40 text-sm leading-relaxed max-w-[300px] mb-2">Tebrikler! ArtÄ±k Kader'in tÃ¼m Ã¶zelliklerine sÄ±nÄ±rsÄ±z eriÅŸimin var.</p>
        <p id="trial-note" class="text-white/25 text-xs mb-8">3 gÃ¼nlÃ¼k Ã¼cretsiz deneme baÅŸladÄ±</p>
        <button id="btn-explore" class="w-full max-w-[300px] pm-grad text-white py-4 rounded-full font-bold text-base flex items-center justify-center gap-2 active:scale-95 transition-transform pm-glow">
            <span class="material-symbols-outlined">explore</span>
            KeÅŸfe BaÅŸla
        </button>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    var params = new URLSearchParams(window.location.search);
    var plan = params.get('plan') || 'yearly';
    var returnUrl = params.get('return') || 'mystic_numerology_home_1.html';

    // Skip butonu â€” returnUrl'e yÃ¶nlendir
    var skipBtn = document.getElementById('btn-skip');
    if (skipBtn) {
        try { skipBtn.href = decodeURIComponent(returnUrl); } catch(e) { skipBtn.href = 'mystic_numerology_home_1.html'; }
    }

    // Plan bilgisi gÃ¶ster
    if (plan === 'yearly') {
        document.getElementById('plan-label').textContent = 'YÄ±llÄ±k Plan';
        document.getElementById('plan-price').textContent = 'â‚º599.99';
        document.getElementById('plan-period').textContent = 'â‚º49.99/ay olarak';
    } else {
        document.getElementById('plan-label').textContent = 'AylÄ±k Plan';
        document.getElementById('plan-price').textContent = 'â‚º79.99';
        document.getElementById('plan-period').textContent = '/ ay';
    }

    // â”€â”€â”€ RevenueCat ile Ã¶deme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var rcReady = false;
    try {
        rcReady = window.premium && typeof window.premium.isReady === 'function' && window.premium.isReady();
        if (!rcReady && window.premium && typeof window.premium.init === 'function') {
            rcReady = await window.premium.init();
        }
    } catch(e) { console.warn('[Checkout] RC init:', e); }

    var selectedPackage = null;
    var paymentContainer = document.getElementById('rc-payment-container');
    var loadingEl = document.getElementById('payment-loading');

    if (rcReady) {
        // Offering'den paketi bul
        selectedPackage = await window.premium.getPackageByPlan(plan);
        if (selectedPackage) {
            loadingEl.innerHTML = '<div class="text-center py-6"><p class="text-white/40 text-sm">AÅŸaÄŸÄ±daki butona basarak Ã¶demeye geÃ§</p><p class="text-white/20 text-xs mt-1">Stripe gÃ¼venli Ã¶deme penceresi aÃ§Ä±lacak</p></div>';
        } else {
            loadingEl.innerHTML = '<div class="text-center py-6"><p class="text-white/40 text-sm">Paket bulunamadÄ±</p><p class="text-white/20 text-xs mt-1">LÃ¼tfen RevenueCat Dashboard\'da Ã¼rÃ¼nleri yapÄ±landÄ±rÄ±n</p></div>';
        }
    } else {
        // SDK hazÄ±r deÄŸil â€” net bilgi ver
        loadingEl.innerHTML = '<div class="text-center py-6">' +
            '<span class="material-symbols-outlined text-amber-400/50 text-3xl mb-3" style="display:block">construction</span>' +
            '<p class="text-white/60 text-sm font-bold mb-1">Ã–deme sistemi henÃ¼z aktif deÄŸil</p>' +
            '<p class="text-white/25 text-xs mb-4">RevenueCat + Stripe baÄŸlantÄ±sÄ± kurulunca otomatik Ã§alÄ±ÅŸacak.</p>' +
            '<button onclick="if(window.premium){window.premium.simulate(30);}" class="px-5 py-2 rounded-full text-xs font-bold" style="background:rgba(139,92,246,0.15);color:#a78bfa;border:1px solid rgba(139,92,246,0.2)">' +
            'ðŸ§ª Test: 30 GÃ¼n Premium SimÃ¼le Et</button>' +
            '</div>';
    }

    // â”€â”€â”€ Ã–deme butonu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-pay').addEventListener('click', async function() {
        var btn = this;
        btn.disabled = true;
        document.getElementById('btn-pay-label').textContent = 'Ä°ÅŸleniyor...';

        if (rcReady && selectedPackage) {
            // RevenueCat SDK Ã¶deme â€” Stripe formu SDK tarafÄ±ndan aÃ§Ä±lÄ±r
            var result = await window.premium.purchasePackage(selectedPackage, paymentContainer);

            if (result.success) {
                // BaÅŸarÄ±!
                document.getElementById('sec-checkout').style.display = 'none';
                document.getElementById('sec-success').style.display = 'flex';
                return;
            } else if (result.error === 'cancelled') {
                btn.disabled = false;
                document.getElementById('btn-pay-label').textContent = 'Ã–demeyi Tamamla';
                return;
            } else {
                // Hata â€” tekrar dene
                btn.disabled = false;
                document.getElementById('btn-pay-label').textContent = 'Tekrar Dene';
                return;
            }
        }

        // â”€â”€â”€ FALLBACK: SDK yoksa simÃ¼lasyon (demo mod) â”€â”€â”€â”€â”€â”€â”€
        await new Promise(function(r) { setTimeout(r, 2000); });
        var days = plan === 'yearly' ? 365 : 30;
        var expires = new Date();
        expires.setDate(expires.getDate() + days + 3);
        localStorage.setItem('kader_premium', JSON.stringify({
            active: true,
            plan: plan,
            expires_at: expires.toISOString(),
            cached_at: new Date().toISOString(),
            source: 'simulated'
        }));
        // Supabase'e de kaydet
        try {
            var session = await window.auth.getSession();
            if (session && session.user) {
                await window.supabaseClient.from('subscriptions').upsert({
                    user_id: session.user.id,
                    plan: plan,
                    status: 'active',
                    starts_at: new Date().toISOString(),
                    expires_at: expires.toISOString(),
                    amount: plan === 'yearly' ? 59999 : 7999,
                    currency: 'TRY',
                    payment_provider: 'simulated',
                    updated_at: new Date().toISOString()
                });
            }
        } catch(e) {}

        document.getElementById('sec-checkout').style.display = 'none';
        document.getElementById('sec-success').style.display = 'flex';
    });

    // â”€â”€â”€ KeÅŸfe baÅŸla â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-explore').addEventListener('click', function() {
        try { window.location.href = decodeURIComponent(returnUrl); }
        catch(e) { window.location.href = 'mystic_numerology_home_1.html'; }
    });
});
</script>
</body>
</html>
